<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>고교 생활 가이드</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='60' font-size='90' text-anchor='middle' dominant-baseline='middle'%3E%F0%9F%8F%AB%3C/text%3E%3C/svg%3E" />

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #eee;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
      overflow: hidden;
    }

    .flipbook-wrapper {
      position: relative;
      margin: 10px auto 0 auto;
      flex-shrink: 0;
    }

    /* 중앙 경계선 그림자 기둥 */
    .flipbook-wrapper::after {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 100%;
      pointer-events: none;
      background: linear-gradient(
        to right,
        rgba(0, 0, 0, 0) 0%,
        rgba(0, 0, 0, 0.05) 30%,
        rgba(0, 0, 0, 0.10) 45%,
        rgba(0, 0, 0, 0.18) 50%,
        rgba(0, 0, 0, 0.10) 55%,
        rgba(0, 0, 0, 0.05) 70%,
        rgba(0, 0, 0, 0) 100%
      );
      filter: blur(5px);
      opacity: 0.85;
      z-index: 0;
      box-shadow: 
        -2px 0 6px rgba(0, 0, 0, 0.08),
        2px 0 6px rgba(0, 0, 0, 0.08);
    }

    /* 페이지 넘김 중에는 그림자 기둥 숨김 (페이지 뒤로 가려짐) */
    .flipbook-wrapper.turning::after {
      opacity: 0;
      transition: opacity 0.15s ease-in;
    }

    /* 페이지 넘김이 끝나면 그림자 기둥 다시 표시 */
    .flipbook-wrapper:not(.turning)::after {
      transition: opacity 0.4s ease-out;
    }

    /* 단면(모바일)에서는 숨김 */
    @media (max-width: 767px) {
      .flipbook-wrapper::after {
        display: none;
      }
    }

    #flipbook {
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      overflow: hidden;
      will-change: transform;
      transform: translateZ(0);
      perspective: 10000px;
      transform-style: preserve-3d;
    }

    /* ✅ 페이지 기본 */
    #flipbook .page {
      position: relative;
      background: #fff;
      overflow: hidden;
      z-index: 2; /* 페이지가 중앙 그림자보다 위로 오도록 */
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      transform-style: preserve-3d;
      transform: translateZ(0);
      transition: box-shadow 0.3s ease-out;
    }

    /* 페이지 넘김 시 동적 그림자 효과 */
    .flipbook-wrapper.turning #flipbook .page {
      box-shadow: 
        0 0 20px rgba(0, 0, 0, 0.15),
        0 10px 30px rgba(0, 0, 0, 0.1);
    }
    

    /* 첫 번째 빈 페이지 스타일 */
    #flipbook .page:first-child {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    /* 페이지 모서리 입체 그림자 제거됨 */

    #flipbook .page iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      transform: translateZ(0);
      transform-origin: top left;
      background: white;
      opacity: 0;
      position: relative;
      z-index: 0;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      -webkit-transform: translateZ(0);
      -webkit-font-smoothing: antialiased;
      will-change: opacity;
    }

    /* 완전히 로드된 iframe만 표시 (transition 없이 즉시) */
    #flipbook .page iframe[data-ready="true"] {
      opacity: 1;
      will-change: auto;
      transition: none;
    }
    
    /* 페이지 전환 중에도 콘텐츠 안정적으로 유지 */
    .flipbook-wrapper.turning #flipbook .page iframe[data-ready="true"] {
      pointer-events: none;
    }

    .nav-btn {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: #1f2937;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
    }
    .nav-btn:hover { 
      background: rgba(255, 255, 255, 1); 
      transform: translateY(-50%) scale(1.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .nav-btn:active { 
      transform: translateY(-50%) scale(0.95);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }
    .nav-btn:focus { outline: none; }

    .prev-btn { padding-left: 2px; }

    /* 하단바 */
    .bottom-bar {
      width: auto;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #64748b;
      font-size: 12px;
      box-sizing: border-box;
      flex-shrink: 0;
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .page-slider-wrapper {
      flex: 1.2;
      min-width: 0;
      display: flex;
      align-items: center;
      width: 85%;
    }

    .page-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 3px;
      border-radius: 999px;
      background: #e2e8f0;
      outline: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .page-slider:hover { background: #cbd5e1; }

    /* 슬라이더 채워진 부분 파란색으로 */
    .page-slider::-webkit-slider-runnable-track {
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(to right, #3b82f6 var(--slider-progress, 0%), #e2e8f0 var(--slider-progress, 0%));
    }

    .page-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      transition: all 0.2s;
      margin-top: -6.5px;
    }
    .page-slider::-webkit-slider-thumb:hover {
      background: #2563eb;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
      transform: scale(1.1);
    }

    .page-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      transition: all 0.2s;
    }
    .page-slider::-moz-range-thumb:hover {
      background: #2563eb;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
      transform: scale(1.1);
    }
    .page-slider::-moz-range-track {
      height: 3px;
      border-radius: 999px;
      background: #e2e8f0;
    }

    /* Firefox에서 슬라이더 채워진 부분 파란색으로 */
    .page-slider::-moz-range-progress {
      height: 3px;
      border-radius: 999px;
      background: #3b82f6;
    }

    .page-label {
      font-variant-numeric: tabular-nums;
      min-width: 50px;
      text-align: center;
      color: #475569;
      font-weight: 500;
      font-size: 12px;
      margin-left: -2px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .page-label .page-number {
      cursor: text;
      transition: all 0.2s ease;
      padding: 2px 4px;
      border-radius: 4px;
      color: #475569;
      display: inline-block;
      min-width: 2.5ch;
    }

    .page-label .page-number:hover {
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .page-label .page-number[contenteditable="true"] {
      outline: 2px solid #3b82f6;
      outline-offset: -2px;
      background: white;
      color: #1e293b;
    }

    .page-label .page-number[contenteditable="true"]:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .page-label .page-slash {
      color: #475569;
    }

    .page-label .page-total {
      color: #475569;
      margin-left: 4px;
    }

    /* 전체화면 버튼 */
    .fullscreen-btn {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: #64748b;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      padding: 0;
      border-radius: 4px;
      transition: all 0.2s ease;
      flex-shrink: 0;
      line-height: 1;
      margin-left: 2px;
      margin-top: 1px;
    }

    .fullscreen-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #3b82f6;
    }

    .fullscreen-btn:hover svg {
      stroke: #3b82f6;
    }

    .fullscreen-btn:active {
      transform: scale(0.95);
    }

    .fullscreen-btn svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.2s ease;
    }
  </style>
</head>
<body>

  <div class="flipbook-wrapper">
    <div id="flipbook"></div>

    <button class="nav-btn prev-btn" id="prevBtn">&#10094;</button>
    <button class="nav-btn next-btn" id="nextBtn">&#10095;</button>
  </div>

  <div class="bottom-bar">
    <div class="page-slider-wrapper">
      <input type="range" min="1" id="pageSlider" class="page-slider">
    </div>
    <span id="pageLabel" class="page-label"></span>
    <button class="fullscreen-btn" id="fullscreenBtn" title="전체화면">
      <svg id="fullscreenIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <circle cx="9" cy="10" r="6"></circle>
        <path d="m14.5 15.5 5.5 5.5"></path>
      </svg>
    </button>
  </div>

  <script>
    const PAGE_FILES = [
      'pages/00.표지/title.html',
      'pages/01.목차/index-01.html',
      'pages/01.목차/index-02.html',
      'pages/02.파트/001.파트1/part1-01.html',
      'pages/02.파트/001.파트1/part1-02.html',
      'pages/02.파트/001.파트1/part1-03.html',
      'pages/02.파트/001.파트1/part1-04.html',
      'pages/02.파트/001.파트1/part1-05.html',
      'pages/02.파트/001.파트1/part1-06.html',
      'pages/02.파트/001.파트1/part1-07.html',
      'pages/03.부록/001.부록1/appendix1-01.html',
      'pages/03.부록/001.부록1/appendix1-02.html',
      'pages/03.부록/001.부록1/appendix1-03.html',
      'pages/03.부록/001.부록1/appendix1-04.html',
      'pages/03.부록/001.부록1/appendix1-05.html',
      'pages/03.부록/002.부록2/appendix2-01.html',
      'pages/03.부록/002.부록2/appendix2-02.html',
      'pages/03.부록/002.부록2/appendix2-03.html',
      'pages/03.부록/002.부록2/appendix2-04.html',
      'pages/03.부록/002.부록2/appendix2-05.html',
      'pages/03.부록/002.부록2/appendix2-06.html',
      'pages/03.부록/003.부록3/appendix3-01.html',
      'pages/03.부록/004.부록4/appendix4-01.html',
      'pages/03.부록/004.부록4/appendix4-02.html',
      'pages/03.부록/004.부록4/appendix4-03.html',
      'pages/03.부록/004.부록4/appendix4-04.html',
      'pages/03.부록/004.부록4/appendix4-05.html',
      'pages/03.부록/004.부록4/appendix4-06.html',
      'pages/03.부록/004.부록4/appendix4-07.html',
      'pages/03.부록/004.부록4/appendix4-08.html',
      'pages/03.부록/004.부록4/appendix4-09.html'
    ];

    const BASE_PAGE_WIDTH = 600;
    const BASE_PAGE_HEIGHT = Math.round(600 * 1.414);
    let bookInitialized = false;

    function setupIframeLoadHandler(iframe) {
      const $iframe = $(iframe);
      if ($iframe.attr("data-handler-setup") === "true") return;
      $iframe.attr("data-handler-setup", "true");
      
      iframe.addEventListener("load", function() {
        // iframe이 완전히 로드되고 내부 콘텐츠까지 렌더링 완료 보장
        function markReady() {
          // 모든 리소스(이미지, 폰트 등)가 완전히 로드될 때까지 대기
          requestAnimationFrame(function() {
            requestAnimationFrame(function() {
              // 이중 requestAnimationFrame으로 렌더링 완료 보장
              $iframe.attr("data-ready", "true");
            });
          });
        }

        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          
          // 이미지 로딩 완료 확인
          function checkImagesLoaded() {
            const images = iframeDoc.querySelectorAll('img');
            let loadedCount = 0;
            const totalImages = images.length;
            
            if (totalImages === 0) {
              markReady();
              return;
            }
            
            images.forEach(function(img) {
              if (img.complete) {
                loadedCount++;
              } else {
                img.addEventListener('load', function() {
                  loadedCount++;
                  if (loadedCount === totalImages) {
                    markReady();
                  }
                });
                img.addEventListener('error', function() {
                  loadedCount++;
                  if (loadedCount === totalImages) {
                    markReady();
                  }
                });
              }
            });
            
            if (loadedCount === totalImages) {
              markReady();
            }
          }
          
          if (iframeDoc.readyState === 'complete') {
            // document.fonts.ready로 폰트 로딩 완료 확인
            if (iframeDoc.fonts && iframeDoc.fonts.ready) {
              iframeDoc.fonts.ready.then(function() {
                setTimeout(checkImagesLoaded, 100);
              });
            } else {
              setTimeout(checkImagesLoaded, 200);
            }
          } else {
            iframeDoc.addEventListener('readystatechange', function() {
              if (iframeDoc.readyState === 'complete') {
                if (iframeDoc.fonts && iframeDoc.fonts.ready) {
                  iframeDoc.fonts.ready.then(function() {
                    setTimeout(checkImagesLoaded, 100);
                  });
                } else {
                  setTimeout(checkImagesLoaded, 200);
                }
              }
            });
          }
        } catch (e) {
          // cross-origin 에러 시 충분한 대기 시간
          setTimeout(function() {
            requestAnimationFrame(function() {
              requestAnimationFrame(function() {
                $iframe.attr("data-ready", "true");
              });
            });
          }, 300);
        }
      }, { once: true });
    }

    function createPages() {
      const $flipbook = $("#flipbook");
      PAGE_FILES.forEach((pageFile, index) => {
        const pageNum = index + 1;

        // ✅ 모든 페이지를 즉시 로드 (loading="eager"로 변경)
        const iframe = $("<iframe></iframe>")
          .attr("src", pageFile + "?flipbook=1")
          .attr("data-src", pageFile + "?flipbook=1")
          .attr("data-src-loaded", "true")
          .attr("loading", "eager")
          .css({ 
            "pointer-events": "auto",
            "transform": "translateZ(0)",
            "will-change": "opacity"
          });

        // 모든 iframe에 로드 핸들러 설정
        setupIframeLoadHandler(iframe[0]);

        const pageClass = (pageNum % 2 === 0) ? "even" : "odd";
        $("<div></div>")
          .addClass("page " + pageClass)
          .attr("data-page", pageNum)
          .append(iframe)
          .appendTo($flipbook);
      });
    }

    function preloadAdjacentPages(currentPage) {
      // ✅ 모든 페이지가 이미 로드되어 있으므로 추가 로드 불필요
      // 안전성을 위해 함수는 유지하되 빈 함수로 처리
    }

    function isMobileView() {
      return window.innerWidth < 768;
    }

    function pageToSliderPos(page, isMobile) {
      if (isMobile) return Math.max(1, Math.min(page || 1, PAGE_FILES.length));
      if (page === 1) return 1;
      return Math.ceil((page - 1) / 2) + 1;
    }

    function sliderPosToPage(sliderPos, isMobile) {
      if (isMobile) return Math.max(1, Math.min(sliderPos || 1, PAGE_FILES.length));
      if (sliderPos === 1) return 1;
      return (sliderPos - 1) * 2;
    }

    function getSliderMax(isMobile) {
      if (isMobile) return PAGE_FILES.length;
      if (PAGE_FILES.length === 1) return 1;
      return Math.ceil((PAGE_FILES.length - 1) / 2) + 1;
    }

    function updateSliderProgress() {
      const $slider = $("#pageSlider");
      const value = parseInt($slider.val(), 10) || 1;
      const max = parseInt($slider.attr("max"), 10) || 1;
      const progress = max > 1 ? ((value - 1) / (max - 1)) * 100 : 0;
      
      // WebKit 브라우저용 그라디언트 설정
      const gradient = `linear-gradient(to right, #3b82f6 ${progress}%, #e2e8f0 ${progress}%)`;
      $slider[0].style.setProperty('--slider-progress', progress + '%');
      
      // 직접 스타일 적용 (WebKit)
      const sliderElement = $slider[0];
      if (sliderElement.style) {
        // WebKit의 경우 track에 직접 적용할 수 없으므로, CSS 변수 사용
        document.documentElement.style.setProperty('--slider-progress', progress + '%');
      }
    }

    function updatePageUI(page, view) {
      const isMobile = isMobileView();
      const sliderPos = pageToSliderPos(page || 1, isMobile);
      $("#pageSlider").val(sliderPos);

      const sliderMax = getSliderMax(isMobile);
      $("#pageSlider").attr("max", sliderMax);

      // 슬라이더 진행률 업데이트
      updateSliderProgress();

      let pageNumberText = "";
      if (view && view.length > 1) {
        const pages = view.filter(p => p && p <= PAGE_FILES.length);
        if (pages.length === 0 || pages[0] === pages[pages.length - 1]) {
          pageNumberText = `${page || 1}`;
        } else {
          pageNumberText = `${pages[0]}-${pages[pages.length - 1]}`;
        }
      } else if (page) {
        pageNumberText = `${page}`;
      }
      
      const $pageLabel = $("#pageLabel");
      const $existingNumber = $pageLabel.find(".page-number");
      if ($existingNumber.length) {
        $existingNumber.text(pageNumberText);
        $pageLabel.find(".page-total").text(PAGE_FILES.length);
      } else {
        $pageLabel.html(`<span class="page-number">${pageNumberText}</span><span class="page-slash">/</span><span class="page-total">${PAGE_FILES.length}</span>`);
      }
    }

    function updateFlipbookLayout() {
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const isMobile = viewportWidth < 768;

      const ARROW_MARGIN = 30;
      const SCREEN_MARGIN = 10;
      const ARROW_WIDTH = 44;
      const navBtnSpace = (ARROW_MARGIN + ARROW_WIDTH + SCREEN_MARGIN) * 2;

      const bottomBarHeight = 40;
      const verticalMargin = 20;

      const maxBookWidth = Math.max(viewportWidth - navBtnSpace, viewportWidth * 0.9);
      const maxBookHeight = viewportHeight - bottomBarHeight - verticalMargin;

      let pageWidth, pageHeight, bookWidth, bookHeight, displayMode;
      const A4_RATIO = 297 / 210;

      if (isMobile) {
        pageWidth = maxBookWidth;
        pageHeight = Math.round(pageWidth * A4_RATIO);
        if (pageHeight > maxBookHeight) {
          pageHeight = maxBookHeight;
          pageWidth = Math.round(pageHeight / A4_RATIO);
        }
        bookWidth = pageWidth;
        bookHeight = pageHeight;
        displayMode = "single";

        const scaleFactor = 0.97;
        bookWidth = Math.round(bookWidth * scaleFactor);
        bookHeight = Math.round(bookHeight * scaleFactor);
        pageWidth = Math.round(pageWidth * scaleFactor);
        pageHeight = Math.round(pageHeight * scaleFactor);
      } else {
        const maxPageWidth = maxBookWidth / 2;
        const maxPageHeight = maxBookHeight;

        if (maxPageWidth * A4_RATIO <= maxPageHeight) {
          pageWidth = maxPageWidth;
          pageHeight = Math.round(pageWidth * A4_RATIO);
        } else {
          pageHeight = maxPageHeight;
          pageWidth = Math.round(pageHeight / A4_RATIO);
        }

        bookWidth = pageWidth * 2;
        bookHeight = pageHeight;
        displayMode = "double";

        const scaleFactor = 0.97;
        bookWidth = Math.round(bookWidth * scaleFactor);
        bookHeight = Math.round(bookHeight * scaleFactor);
        pageWidth = Math.round(pageWidth * scaleFactor);
        pageHeight = Math.round(pageHeight * scaleFactor);
      }

      $(".flipbook-wrapper").css({ width: bookWidth, height: bookHeight });
      $("#flipbook").css({ width: bookWidth, height: bookHeight });
      $("#flipbook .page").css({ width: pageWidth, height: pageHeight });
      $(".bottom-bar").css({ width: bookWidth });

      setTimeout(function() {
        $("#flipbook .page iframe[data-ready='true']").each(function() {
          try {
            if (this.contentWindow) {
              this.contentWindow.postMessage({
                type: 'flipbook-resize',
                width: pageWidth,
                height: pageHeight
              }, '*');
            }
          } catch (e) {}
        });
      }, 300);

      if (!bookInitialized) {
        $("#flipbook").turn({
          width: bookWidth,
          height: bookHeight,
          display: displayMode,
          autoCenter: true,
          elevation: 0,
          gradients: false,
          duration: 1000,
          acceleration: true,
          when: {
            turning: function(event, page, view) {
              $(".flipbook-wrapper").addClass("turning");

              $("#flipbook .page").removeClass("even odd");
              $("#flipbook .page").each(function(index) {
                if ((index + 1) % 2 === 0) $(this).addClass("even");
                else $(this).addClass("odd");
              });
            },
            turned: function(event, page, view) {
              // 현재 보이는 페이지의 iframe이 완전히 로드되었는지 확인
              const currentPages = view || [page];
              let allReady = true;
              
              currentPages.forEach(function(p) {
                const $page = $("#flipbook .page[data-page='" + p + "']");
                const $iframe = $page.find("iframe");
                if ($iframe.length && !$iframe.attr("data-ready")) {
                  allReady = false;
                }
              });
              
              // 모든 페이지가 준비되었을 때만 turning 제거
              if (allReady) {
                requestAnimationFrame(function() {
                  $(".flipbook-wrapper").removeClass("turning");
                  updatePageUI(page, view);
                });
              } else {
                // 아직 로딩 중이면 잠시 후 다시 확인
                setTimeout(function() {
                  requestAnimationFrame(function() {
                    $(".flipbook-wrapper").removeClass("turning");
                    updatePageUI(page, view);
                  });
                }, 100);
              }
            }
          }
        });
        
        // 자연스러운 easing 함수 적용
        $.extend($.easing, {
          easeOutQuad: function(x, t, b, c, d) {
            return -c * (t /= d) * (t - 2) + b;
          }
        });

        $("#flipbook .page").each(function(index) {
          if ((index + 1) % 2 === 0) $(this).addClass("even");
          else $(this).addClass("odd");
        });

        bookInitialized = true;
      } else {
        $("#flipbook").turn("size", bookWidth, bookHeight);
        $("#flipbook").turn("display", displayMode);

        $("#flipbook .page").removeClass("even odd");
        $("#flipbook .page").each(function(index) {
          if ((index + 1) % 2 === 0) $(this).addClass("even");
          else $(this).addClass("odd");
        });
      }

      const page = $("#flipbook").turn("page") || 1;
      const view = $("#flipbook").turn("view");
      
      // 모바일에서 슬라이더 max를 명시적으로 업데이트
      const sliderMax = getSliderMax(isMobile);
      $("#pageSlider").attr("max", sliderMax);
      
      updatePageUI(page, view);
      updateNavButtonPosition();
    }

    function updateNavButtonPosition() {
      const ARROW_MARGIN = 30;
      const MIN_SCREEN_MARGIN = 10;

      const $flipbookWrapper = $(".flipbook-wrapper");
      const $prevBtn = $("#prevBtn");
      const $nextBtn = $("#nextBtn");

      if ($flipbookWrapper.length && $prevBtn.length && $nextBtn.length) {
        const wrapperRect = $flipbookWrapper[0].getBoundingClientRect();
        const wrapperLeft = wrapperRect.left;
        const wrapperRight = wrapperRect.right;
        const wrapperTop = wrapperRect.top;
        const wrapperHeight = wrapperRect.height;

        const viewportWidth = window.innerWidth;

        let prevLeft = wrapperLeft - ARROW_MARGIN - 44;
        if (prevLeft < MIN_SCREEN_MARGIN) prevLeft = MIN_SCREEN_MARGIN;

        let nextLeft = wrapperRight + ARROW_MARGIN;
        if (nextLeft + 44 > viewportWidth - MIN_SCREEN_MARGIN) {
          nextLeft = viewportWidth - 44 - MIN_SCREEN_MARGIN;
        }

        $prevBtn.css({
          left: prevLeft + 'px',
          top: (wrapperTop + wrapperHeight / 2) + 'px'
        });

        $nextBtn.css({
          left: nextLeft + 'px',
          top: (wrapperTop + wrapperHeight / 2) + 'px'
        });
      }
    }

    // 전체화면 전환 함수
    function requestFullscreen() {
      const elem = document.documentElement;
      
      if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => {
          console.log('전체화면 요청 실패:', err);
        });
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    }

    // 전체화면 종료 함수
    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }

    // 전체화면 상태 확인 함수
    function isFullscreen() {
      return !!(document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.mozFullScreenElement || 
                document.msFullscreenElement);
    }

    // 전체화면 아이콘 업데이트
    function updateFullscreenIcon() {
      // SVG 아이콘은 상태에 따라 변경할 필요 없음 (동일한 돋보기 아이콘 사용)
    }

    $(document).ready(function () {
      createPages();

      const isMobile = isMobileView();
      $("#pageSlider").attr("max", getSliderMax(isMobile)).val(1);

      updateFlipbookLayout();
      // 초기 로딩 시 기둥이 바로 보이도록 보장
      $(".flipbook-wrapper").removeClass("turning");

      // 전체화면 버튼 클릭 이벤트
      $("#fullscreenBtn").on("click", function() {
        if (isFullscreen()) {
          exitFullscreen();
        } else {
          requestFullscreen();
        }
      });

      // 전체화면 상태 변경 감지
      document.addEventListener('fullscreenchange', updateFullscreenIcon);
      document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
      document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
      document.addEventListener('MSFullscreenChange', updateFullscreenIcon);

      // 초기 아이콘 상태 설정
      updateFullscreenIcon();

      $("#flipbook").bind("turned", function (e, page, view) {
        // 현재 보이는 페이지의 iframe이 완전히 로드되었는지 확인
        const currentPages = view || [page];
        let allReady = true;
        
        currentPages.forEach(function(p) {
          const $page = $("#flipbook .page[data-page='" + p + "']");
          const $iframe = $page.find("iframe");
          if ($iframe.length && !$iframe.attr("data-ready")) {
            allReady = false;
          }
        });
        
        // 모든 페이지가 준비되었을 때만 turning 제거
        function finalize() {
          requestAnimationFrame(function() {
            $(".flipbook-wrapper").removeClass("turning");

            $("#flipbook .page").removeClass("even odd");
            $("#flipbook .page").each(function(index) {
              if ((index + 1) % 2 === 0) $(this).addClass("even");
              else $(this).addClass("odd");
            });

            // 모바일에서 슬라이더 max를 명시적으로 업데이트
            const isMobileCheck = isMobileView();
            const sliderMax = getSliderMax(isMobileCheck);
            $("#pageSlider").attr("max", sliderMax);
            
            updatePageUI(page, view);
            requestAnimationFrame(function() {
              updateNavButtonPosition();
            });
          });
        }
        
        if (allReady) {
          finalize();
        } else {
          // 아직 로딩 중이면 잠시 후 다시 확인
          setTimeout(function() {
            finalize();
          }, 150);
        }
      });

      $("#prevBtn").click(function() {
        $("#flipbook").turn("previous");
      });

      $("#nextBtn").click(function() {
        $("#flipbook").turn("next");
      });

      $("#pageSlider").on("input change", function () {
        const sliderPos = parseInt($(this).val(), 10);
        const isMobile = isMobileView();
        const targetPage = sliderPosToPage(sliderPos, isMobile);
        updateSliderProgress();
        $("#flipbook").turn("page", targetPage);
      });

      // 페이지 번호 클릭 시 직접 편집 가능하게
      $(document).on("click", ".page-number", function(e) {
        e.stopPropagation();
        const $numberSpan = $(this);
        if ($numberSpan.attr("contenteditable") === "true") return; // 이미 편집 모드면 무시
        
        const currentPage = $("#flipbook").turn("page") || 1;
        const originalText = $numberSpan.text();
        
        // 범위 형식(8-9)인 경우 첫 번째 숫자만 추출
        const firstPage = parseInt(originalText.split('-')[0], 10) || currentPage;
        
        $numberSpan
          .attr("contenteditable", "true")
          .text(firstPage)
          .focus();
        
        // 텍스트 전체 선택
        const range = document.createRange();
        range.selectNodeContents($numberSpan[0]);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      });
      
      // 페이지 번호 편집 완료 시
      $(document).on("keydown", ".page-number[contenteditable='true']", function(e) {
        const $numberSpan = $(this);
        const maxPage = PAGE_FILES.length;
        
        if (e.key === "Enter") {
          e.preventDefault();
          const pageNum = parseInt($numberSpan.text(), 10);
          if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= maxPage) {
            $("#flipbook").turn("page", pageNum);
          }
          $numberSpan.attr("contenteditable", "false");
        } else if (e.key === "Escape") {
          e.preventDefault();
          const currentPage = $("#flipbook").turn("page") || 1;
          $numberSpan.text(currentPage);
          $numberSpan.attr("contenteditable", "false");
        }
      });
      
      // 포커스가 벗어나면 편집 모드 해제
      $(document).on("blur", ".page-number[contenteditable='true']", function() {
        const $numberSpan = $(this);
        const maxPage = PAGE_FILES.length;
        const pageNum = parseInt($numberSpan.text(), 10);
        
        if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= maxPage) {
          $("#flipbook").turn("page", pageNum);
        } else {
          // 유효하지 않은 값이면 현재 페이지로 복구
          const currentPage = $("#flipbook").turn("page") || 1;
          $numberSpan.text(currentPage);
        }
        
        $numberSpan.attr("contenteditable", "false");
      });

      $(window).on("resize", function() {
        const isMobile = isMobileView();
        $("#pageSlider").attr("max", getSliderMax(isMobile));

        const currentPage = $("#flipbook").turn("page") || 1;
        const currentSliderPos = pageToSliderPos(currentPage, isMobile);
        $("#pageSlider").val(currentSliderPos);
        updateSliderProgress();

        updateFlipbookLayout();

        setTimeout(function() {
          $("#flipbook .page").removeClass("even odd");
          $("#flipbook .page").each(function(index) {
            if ((index + 1) % 2 === 0) $(this).addClass("even");
            else $(this).addClass("odd");
          });
        }, 100);

        setTimeout(updateNavButtonPosition, 100);
      });

      updatePageUI(1, [1]);
      setTimeout(updateNavButtonPosition, 200);
    });
  </script>
</body>
</html>